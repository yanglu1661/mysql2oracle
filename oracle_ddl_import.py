#!/usr/bin/python3
import os
import argparse
import configparser
import oracledb
import re
import io

# -----------------------------
# å®‰å…¨æ‹†åˆ† SQL æ–‡ä»¶
# -----------------------------
def split_sql_statements(sql_text):
    """
    å®‰å…¨æ‹†åˆ† SQL æ–‡ä»¶ä¸ºç‹¬ç«‹è¯­å¥ã€‚
    å¿½ç•¥å­—ç¬¦ä¸²å¼•å·ä¸­çš„åˆ†å·ï¼Œé¿å… COMMENT ä¸­å¤šè¡Œå­—ç¬¦ä¸²è¢«æˆªæ–­ã€‚
    """
    statements = []
    buffer = io.StringIO()
    in_quote = False
    escape = False

    for char in sql_text:
        if char == "'" and not escape:
            in_quote = not in_quote
        elif char == ";" and not in_quote:
            stmt = buffer.getvalue().strip()
            if stmt:
                statements.append(stmt)
            buffer = io.StringIO()
            continue
        elif char == "\\":
            escape = not escape
        else:
            escape = False
        buffer.write(char)

    # æ”¶å°¾éƒ¨åˆ†
    last_stmt = buffer.getvalue().strip()
    if last_stmt:
        statements.append(last_stmt)
    return statements


# -----------------------------
# è§£æå‘½ä»¤è¡Œå‚æ•°
# -----------------------------
parser = argparse.ArgumentParser(description="å¯¼å…¥ Oracle DDL æ–‡ä»¶")
group = parser.add_mutually_exclusive_group(required=True)
group.add_argument('--ddl', action='store_true', help='ä»…å¯¼å…¥é foreign_keys çš„ DDL æ–‡ä»¶')
group.add_argument('--foreign-keys', action='store_true', help='ä»…å¯¼å…¥ foreign_keys çš„ DDL æ–‡ä»¶')
args = parser.parse_args()

# -----------------------------
# è¯»å–é…ç½®æ–‡ä»¶
# -----------------------------
config = configparser.ConfigParser()
config.read('config.ini')

oracle_conf = config['oracledb']
username = oracle_conf.get('username').strip()
password = oracle_conf.get('password').strip()
host = oracle_conf.get('host').strip()
port = oracle_conf.get('port').strip()
service_name = oracle_conf.get('service_name').strip()

# -----------------------------
# æ„å»º Oracle è¿æ¥
# -----------------------------
try:
    conn = oracledb.connect(user=username, password=password, dsn=f"{host}:{port}/{service_name}")
    print("âœ… æˆåŠŸè¿æ¥åˆ° Oracle æ•°æ®åº“")
except oracledb.Error as e:
    print("âŒ Oracle æ•°æ®åº“è¿æ¥å¤±è´¥:", e)
    exit(1)

cursor = conn.cursor()

ddl_dir = 'oracle_schema_ddl'

# -----------------------------
# æ­£åˆ™ï¼šä¿®å¤ NOT NULL GENERATED IDENTITY é¡ºåº
# -----------------------------
pattern = re.compile(
    r'(NOT NULL\s+GENERATED BY DEFAULT AS IDENTITY)|(GENERATED BY DEFAULT AS IDENTITY\s+NOT NULL)',
    re.IGNORECASE
)

# -----------------------------
# éå†ç›®å½•å¹¶æ‰§è¡Œ SQL
# -----------------------------
for filename in sorted(os.listdir(ddl_dir)):
    if not filename.endswith('.oracle.sql'):
        continue

    is_fk = 'foreign_keys' in filename

    # æ ¹æ®å‚æ•°å†³å®šæ˜¯å¦å¤„ç†è¯¥æ–‡ä»¶
    if args.ddl and is_fk:
        continue
    if args.foreign_keys and not is_fk:
        continue

    file_path = os.path.join(ddl_dir, filename)
    print(f"\nğŸ“„ æ­£åœ¨å¯¼å…¥ï¼š{filename}")

    with open(file_path, 'r', encoding='utf-8') as f:
        sql_content = f.read()

    # æ›¿æ¢ IDENTITY é¡ºåº
    sql_content = pattern.sub('GENERATED BY DEFAULT AS IDENTITY', sql_content)

    # å»é™¤å•è¡Œæ³¨é‡Š
    cleaned_sql = '\n'.join(
        line for line in sql_content.splitlines() if not line.strip().startswith('--')
    )

    # ä½¿ç”¨å®‰å…¨æ‹†åˆ†é€»è¾‘
    statements = split_sql_statements(cleaned_sql)

    # -----------------------------
    # æ‰§è¡Œæ¯æ¡ SQL
    # -----------------------------
    for idx, stmt in enumerate(statements, 1):
        try:
            #print(f"\nâ¡ï¸ Execute statement #{idx}:\n{stmt}")
            cursor.execute(stmt)
        except oracledb.DatabaseError as e:
            print(f"âŒ ç¬¬ {idx} æ¡ SQL æ‰§è¡Œå¤±è´¥ in {filename}:")
            print("   SQL ç‰‡æ®µï¼š", stmt[:120].replace('\n', ' '))
            print("   é”™è¯¯ä¿¡æ¯ï¼š", e)

# -----------------------------
# æäº¤å¹¶å…³é—­è¿æ¥
# -----------------------------
conn.commit()
cursor.close()
conn.close()
print("\nâœ… æ‰€æœ‰é€‰å®šçš„ DDL å¯¼å…¥å®Œæˆ")
