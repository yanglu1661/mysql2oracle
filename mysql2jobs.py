#!/usr/bin/python3
import os
import re
import pymysql
import configparser
import subprocess
from openai import OpenAI
from concurrent.futures import ThreadPoolExecutor, as_completed

# ======== é…ç½®åŠ è½½ ========
config = configparser.ConfigParser()
config.read('config.ini')

mysql_conf = config['mysql']
output_conf = config['ddl_output']
ai_conf = config['openai']

INPUT_DIR = output_conf.get('input_dir', 'mysql_schema_raw')
OUTPUT_DIR = output_conf.get('output_dir', 'oracle_schema_ddl')
MAX_WORKERS = int(ai_conf.get('max_workers', 5))

# ======== åˆ›å»º DeepSeek å®¢æˆ·ç«¯ ========
client = OpenAI(api_key=ai_conf['api_key'], base_url=ai_conf['api_base'])

# ======== AI è½¬æ¢å‡½æ•° ========
def convert_to_oracle_via_ai(mysql_sql: str) -> str:
    prompt = f"""
ä½ æ˜¯ä¸€ä¸ªæ•°æ®åº“è¿ç§»ä¸“å®¶ï¼Œå¿…é¡»å°†ä»¥ä¸‹MySQLè¡¨ç»“æ„ç²¾ç¡®è½¬æ¢ä¸ºOracle 23aiå…¼å®¹çš„SQL DDLã€‚

æ ¸å¿ƒè¦æ±‚ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š
1. ä¿ç•™æ‰€æœ‰åŸå§‹æ³¨é‡Šå†…å®¹ï¼ŒåŒ…æ‹¬è¡¨æ³¨é‡Šå’Œåˆ—æ³¨é‡Š
2. è¡¨æ³¨é‡Šä½¿ç”¨: COMMENT ON TABLE è¡¨å IS 'æ³¨é‡Šå†…å®¹';
3. åˆ—æ³¨é‡Šä½¿ç”¨: COMMENT ON COLUMN è¡¨å.åˆ—å IS 'æ³¨é‡Šå†…å®¹';
4. æ‰€æœ‰æ³¨é‡Šå¿…é¡»æ”¾åœ¨CREATE TABLEè¯­å¥ä¹‹å

è½¬æ¢è§„åˆ™ï¼š
- AUTO_INCREMENT â†’ GENERATED BY DEFAULT AS IDENTITYï¼Œä¸”ç¡®ä¿æœ€ç»ˆå½¢å¼ä¸º "GENERATED BY DEFAULT AS IDENTITY"ï¼ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„ NOT NULLï¼‰
- ENGINE=InnoDB ç­‰å­˜å‚¨å¼•æ“å£°æ˜å¿…é¡»ç§»é™¤ï¼Œä¸”ç¡®ä¿ç”Ÿæˆå®Œæ•´å¯æ‰§è¡Œçš„ SQLï¼Œå­—æ®µå®šä¹‰åœ¨åŒä¸€è¡Œ
- DATETIME â†’ TIMESTAMPï¼Œä¸” DEFAULT å­å¥éœ€æ”¾åœ¨æ•°æ®ç±»å‹ä¹‹åï¼Œçº¦æŸï¼ˆå¦‚ NOT NULLï¼‰ä¹‹å‰
- TINYINT â†’ NUMBER (3)ï¼Œä¸” DEFAULT å­å¥éœ€æ”¾åœ¨æ•°æ®ç±»å‹ä¹‹åï¼Œçº¦æŸï¼ˆå¦‚ NOT NULLï¼‰ä¹‹å‰
- TEXT ç±»å‹ â†’ CLOBï¼Œä¸” DEFAULT å­å¥éœ€æ”¾åœ¨æ•°æ®ç±»å‹ä¹‹åï¼Œçº¦æŸï¼ˆå¦‚ NOT NULLï¼‰ä¹‹å‰
- ENUM ç±»å‹ â†’ VARCHAR2 å¹¶æ·»åŠ  CHECK çº¦æŸï¼Œä¸” DEFAULT å­å¥éœ€æ”¾åœ¨æ•°æ®ç±»å‹ä¹‹åï¼Œçº¦æŸï¼ˆå¦‚ NOT NULLï¼‰ä¹‹å‰
- FLOAT (p,s) å’Œ DOUBLE (p,s) â†’ NUMBER (p,s)ï¼Œä¸” DEFAULT å­å¥éœ€æ”¾åœ¨æ•°æ®ç±»å‹ä¹‹åï¼Œçº¦æŸï¼ˆå¦‚ NOT NULLï¼‰ä¹‹å‰
- ç§»é™¤æ‰€æœ‰ "IF EXISTS" è¯­å¥ï¼Œä¸”ç¡®ä¿ç”Ÿæˆå®Œæ•´å¯æ‰§è¡Œçš„ SQLï¼Œå­—æ®µå®šä¹‰åœ¨åŒä¸€è¡Œ
- DEFAULT å­å¥éœ€æ”¾åœ¨æ•°æ®ç±»å‹ä¹‹åï¼Œçº¦æŸï¼ˆå¦‚ NOT NULLï¼‰ä¹‹å‰
- é’ˆå¯¹ç´¢å¼•æˆ–ä¸»é”®è½¬æ¢ä¸º Oracle constraint æ—¶ï¼Œéœ€è¦æ·»åŠ è¡¨åä½œä¸ºå‰ç¼€ï¼ˆå¦‚åŸçº¦æŸä¸º udx_laguage_tag_codeï¼Œè¡¨åä¸º language_infoï¼Œåˆ™è½¬æ¢ä¸º CONSTRAINT language_info_udx_laguage_tag_code UNIQUE (language_tag, code, deleted)ï¼‰ï¼Œé¿å… constraint é‡åé”™è¯¯

MySQLå®šä¹‰ï¼š
{mysql_sql}

è¾“å‡ºæ ¼å¼ï¼ˆåªè¿”å›SQLï¼Œæ— å…¶ä»–è¯´æ˜ï¼‰ï¼š
CREATE TABLE ... (
  ...
);
COMMENT ON TABLE ...;
COMMENT ON COLUMN ...;
...

MySQL å®šä¹‰å¦‚ä¸‹ï¼š
{mysql_sql}
"""
    response = client.chat.completions.create(
        model="deepseek-chat",
        messages=[{"role": "user", "content": prompt}],
        max_tokens=4096
    )
    res = response.choices[0].message.content.strip()
    res = re.sub(r"^```(sql|plsql)?", "", res).replace("```", "").strip()
    return res

# ======== å¯¼å‡ºæ‰€æœ‰è¡¨ç»“æ„ï¼ˆå«ç´¢å¼•ä¸çº¦æŸï¼‰ ========
def extract_table_ddl(conn, schema=None):
    cur = conn.cursor()

    # è·å–æ‰€æœ‰è¡¨å
    if schema:
        cur.execute("SHOW TABLES")
    else:
        cur.execute("SHOW TABLES")

    tables = [row[0] for row in cur.fetchall()]

    os.makedirs(INPUT_DIR, exist_ok=True)
    print(f"å‘ç° {len(tables)} ä¸ªè¡¨ï¼Œå¼€å§‹å¯¼å‡º...")

    for table in tables:
        filename = f"{table}.sql"
        filepath = os.path.join(INPUT_DIR, filename)
        try:
            # è·å–è¡¨åˆ›å»ºè¯­å¥
            cur.execute(f"SHOW CREATE TABLE `{table}`")
            create_table_stmt = cur.fetchone()[1]

            with open(filepath, 'w', encoding='utf-8') as f:
                f.write(create_table_stmt)
            print(f"âœ… å¯¼å‡ºè¡¨ç»“æ„ï¼š{filename}")
        except Exception as e:
            print(f"âŒ å¯¼å‡ºå¤±è´¥ï¼š{filename}\né”™è¯¯ä¿¡æ¯: {str(e)}")

def process_single_file(filename):
    try:
        input_path = os.path.join(INPUT_DIR, filename)
        with open(input_path, 'r', encoding='utf-8') as f:
            mysql_sql = f.read()

        print(f"ğŸ”„ æ­£åœ¨è½¬æ¢ï¼š{filename}")
        oracle_sql = convert_to_oracle_via_ai(mysql_sql)

        # è°ƒè¯•ï¼šæ‰“å°AIè¿”å›çš„å†…å®¹
        print(f"AIè¿”å›å†…å®¹:\n{oracle_sql}\n")

        # é¦–å…ˆæ£€æŸ¥AIè¿”å›çš„SQLæ˜¯å¦å·²ç»æ˜¯å®Œæ•´çš„
        if "CREATE TABLE" in oracle_sql and ";" in oracle_sql:
            # AIè¿”å›äº†å®Œæ•´çš„SQLï¼Œç›´æ¥ä½¿ç”¨
            final_sql = oracle_sql
        else:
            # ä½¿ç”¨æ”¹è¿›çš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…CREATE TABLE
            # åŒ¹é…æ•´ä¸ªCREATE TABLEè¯­å¥ï¼ŒåŒ…æ‹¬è¡¨åã€åˆ—å®šä¹‰å’Œè¡¨é€‰é¡¹
            create_table_pattern = r'CREATE\s+TABLE\s+([^\s(]+)\s*\(([^)]+)\)\s*([^;]*);?'
            match = re.search(create_table_pattern, oracle_sql, re.DOTALL | re.IGNORECASE)
            
            if not match:
                # å¦‚æœæ­£åˆ™åŒ¹é…å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä½¿ç”¨AIè¿”å›çš„å†…å®¹
                print(f"âš ï¸ æ— æ³•è§£æCREATE TABLEè¯­å¥ï¼Œç›´æ¥ä½¿ç”¨AIè¿”å›å†…å®¹: {filename}")
                final_sql = oracle_sql
            else:
                table_name = match.group(1).strip('`"')
                columns_body = match.group(2)
                table_options = match.group(3).strip()
                
                # å¤„ç†åˆ—å®šä¹‰ - æŒ‰é€—å·åˆ†å‰²ï¼Œä½†è¦æ³¨æ„ä¸è¦åˆ†å‰²å‡½æ•°å†…éƒ¨çš„é€—å·
                lines = []
                current_line = ""
                paren_depth = 0
                
                for char in columns_body:
                    if char == '(':
                        paren_depth += 1
                        current_line += char
                    elif char == ')':
                        paren_depth -= 1
                        current_line += char
                    elif char == ',' and paren_depth == 0:
                        lines.append(current_line.strip())
                        current_line = ""
                    else:
                        current_line += char
                
                if current_line.strip():
                    lines.append(current_line.strip())
                
                # è¿‡æ»¤ç©ºè¡Œå¹¶é‡æ–°æ ¼å¼åŒ–
                cleaned_lines = [line for line in lines if line.strip()]
                
                # é‡å»ºCREATE TABLEè¯­å¥
                create_table_sql = f"CREATE TABLE {table_name} (\n  " + ",\n  ".join(cleaned_lines) + "\n)"
                
                if table_options:
                    final_sql = f"{create_table_sql} {table_options};"
                else:
                    final_sql = f"{create_table_sql};"

        table_name = filename.replace('.sql', '')
        output_main_path = os.path.join(OUTPUT_DIR, f"{table_name}.oracle.sql")
        
        with open(output_main_path, 'w', encoding='utf-8') as f:
            f.write(final_sql.strip())
        
        print(f"âœ… DDLæ–‡ä»¶å†™å…¥ï¼š{output_main_path}")

    except Exception as e:
        print(f"âŒ è½¬æ¢å¤±è´¥ï¼š{filename}ï¼Œé”™è¯¯ï¼š{e}")
        # åœ¨é”™è¯¯æ—¶ä¿å­˜åŸå§‹AIè¾“å‡ºä»¥ä¾¿è°ƒè¯•
        debug_path = os.path.join(OUTPUT_DIR, f"{filename}.debug")
        with open(debug_path, 'w', encoding='utf-8') as f:
            f.write(f"Original AI output:\n{oracle_sql}\n\nError: {e}")

# ======== å¹¶å‘è½¬æ¢å‡½æ•° ========
def convert_all_mysql_to_oracle_concurrently():
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    sql_files = [f for f in os.listdir(INPUT_DIR) if f.endswith('.sql')]

    with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
        futures = [executor.submit(process_single_file, file) for file in sql_files]
        for future in as_completed(futures):
            future.result()  # æ•è·å¼‚å¸¸è¾“å‡º

# ======== ä¸»å‡½æ•°å…¥å£ ========
def main():
    conn = pymysql.connect(
        host=mysql_conf['host'],
        port=mysql_conf.getint('port', 3306),
        user=mysql_conf['user'],
        password=mysql_conf['password'],
        database=mysql_conf['dbname'],
        charset='utf8mb4'
    )

    extract_table_ddl(conn)
    convert_all_mysql_to_oracle_concurrently()
    conn.close()

if __name__ == "__main__":
    main()
