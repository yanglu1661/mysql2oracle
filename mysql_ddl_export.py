#!/usr/bin/env python3
import os
import re
import pymysql
import configparser
import subprocess
from openai import OpenAI
from concurrent.futures import ThreadPoolExecutor, as_completed

# ======== é…ç½®åŠ è½½ ========
config = configparser.ConfigParser()
config.read('config.ini')

mysql_conf = config['mysql']
output_conf = config['ddl_output']
ai_conf = config['openai']

INPUT_DIR = output_conf.get('input_dir', 'mysql_schema_raw')
OUTPUT_DIR = output_conf.get('output_dir', 'oracle_schema_ddl')
MAX_WORKERS = int(ai_conf.get('max_workers', 5))

# ======== åˆ›å»º DeepSeek å®¢æˆ·ç«¯ ========
client = OpenAI(api_key=ai_conf['api_key'], base_url=ai_conf['api_base'])

# ======== AI è½¬æ¢å‡½æ•° ========
def convert_to_oracle_via_ai(mysql_sql: str) -> str:
    prompt = f"""
ä½ æ˜¯ä¸€ä¸ªæ•°æ®åº“è¿ç§»ä¸“å®¶ï¼Œè¯·å°†ä»¥ä¸‹ MySQL è¡¨ç»“æ„å®šä¹‰ï¼ˆåŒ…å«ç´¢å¼•å’Œçº¦æŸï¼‰è½¬æ¢ä¸º Oracle å…¼å®¹çš„ SQL DDLã€‚
ä»…ä»¥çº¯æ–‡æœ¬æ ¼å¼ç»™æˆ‘å›å¤ã€‚å›å¤ä¸éœ€è¦ä»»ä½•å…³äºä¿®æ”¹çš„å†…å®¹çš„è¯´æ˜ã€‚
ä¿ç•™æ³¨é‡Šï¼Œå»æ‰"IF EXISTS"è¯­å¥ï¼ŒMySQL çš„ç±»å‹åº”è½¬æ¢ä¸ºå¯¹åº”çš„ Oracle ç±»å‹ã€‚è¯·ä½¿ç”¨æ ‡å‡† Oracle è¯­æ³•ã€‚

ç‰¹åˆ«æ³¨æ„ä»¥ä¸‹è½¬æ¢è§„åˆ™ï¼š
1. AUTO_INCREMENT è½¬æ¢ä¸º Oracle çš„ GENERATED BY DEFAULT AS IDENTITY
2. ENGINE=InnoDB ç­‰å­˜å‚¨å¼•æ“å£°æ˜éœ€è¦å»æ‰
3. å°† DATETIME è½¬æ¢ä¸º TIMESTAMP
4. å°† TINYINT è½¬æ¢ä¸º NUMBER(3)
5. å°† TEXT ç±»å‹è½¬æ¢ä¸º CLOB
6. å°† ENUM ç±»å‹è½¬æ¢ä¸º VARCHAR2 å¹¶æ·»åŠ  CHECK çº¦æŸ
7. å°† FLOAT(p,s) å’Œ DOUBLE(p,s) è½¬æ¢ä¸º NUMBER(p,s)

MySQL å®šä¹‰å¦‚ä¸‹ï¼š
{mysql_sql}
"""
    response = client.chat.completions.create(
        model="deepseek-chat",
        messages=[{"role": "user", "content": prompt}],
        max_tokens=4096
    )
    res = response.choices[0].message.content.strip()
    res = re.sub(r"^```(sql|plsql)?", "", res).replace("```", "").strip()
    return res

# ======== å¯¼å‡ºæ‰€æœ‰è¡¨ç»“æ„ï¼ˆå«ç´¢å¼•ä¸çº¦æŸï¼‰ ========
def extract_table_ddl(conn, schema=None):
    cur = conn.cursor()
    
    # è·å–æ‰€æœ‰è¡¨å
    if schema:
        cur.execute("SHOW TABLES")
    else:
        cur.execute("SHOW TABLES")
    
    tables = [row[0] for row in cur.fetchall()]

    os.makedirs(INPUT_DIR, exist_ok=True)
    print(f"å‘ç° {len(tables)} ä¸ªè¡¨ï¼Œå¼€å§‹å¯¼å‡º...")

    for table in tables:
        filename = f"{table}.sql"
        filepath = os.path.join(INPUT_DIR, filename)
        try:
            # è·å–è¡¨åˆ›å»ºè¯­å¥
            cur.execute(f"SHOW CREATE TABLE `{table}`")
            create_table_stmt = cur.fetchone()[1]
            
            with open(filepath, 'w', encoding='utf-8') as f:
                f.write(create_table_stmt)
            print(f"âœ… å¯¼å‡ºè¡¨ç»“æ„ï¼š{filename}")
        except Exception as e:
            print(f"âŒ å¯¼å‡ºå¤±è´¥ï¼š{filename}\né”™è¯¯ä¿¡æ¯: {str(e)}")

def process_single_file(filename):
    try:
        input_path = os.path.join(INPUT_DIR, filename)
        with open(input_path, 'r', encoding='utf-8') as f:
            mysql_sql = f.read()

        print(f"ğŸ”„ æ­£åœ¨è½¬æ¢ï¼š{filename}")
        oracle_sql = convert_to_oracle_via_ai(mysql_sql)

        table_name = filename.replace('.sql', '')
        output_main_path = os.path.join(OUTPUT_DIR, f"{table_name}.oracle.sql")
        output_fk_path = os.path.join(OUTPUT_DIR, f"{table_name}.foreign_keys.sql")

        # åŒ¹é… CREATE TABLE è¯­å¥
        create_table_match = re.search(r'CREATE TABLE\s+(\w+)\s*\((.*?)\);', oracle_sql, re.DOTALL | re.IGNORECASE)
        if not create_table_match:
            raise ValueError(f"æ— æ³•è§£æ CREATE TABLE è¯­å¥ï¼š{filename}")

        table_name_in_ddl = create_table_match.group(1)
        table_body = create_table_match.group(2)

        lines = [line.strip() for line in table_body.split(',\n') if line.strip()]
        new_lines = []
        foreign_keys = []

        for line in lines:
            if re.search(r'\bFOREIGN\s+KEY\b', line, re.IGNORECASE):
                constraint_name = re.search(r'CONSTRAINT\s+(\w+)', line, re.IGNORECASE)
                constraint = constraint_name.group(1) if constraint_name else 'fk_unknown'
                foreign_keys.append(f"ALTER TABLE {table_name_in_ddl} ADD {line.strip()};")
            else:
                new_lines.append(line.strip())

        # é‡å»º CREATE TABLE
        create_table_sql = f"CREATE TABLE {table_name_in_ddl} (\n  " + ",\n  ".join(new_lines) + "\n);"

        # æŠŠä¸» DDL å’Œç´¢å¼•è¯­å¥æå–å‡ºæ¥
        rest_ddl = oracle_sql.split(");", 1)[-1].strip()
        final_main_sql = create_table_sql + ("\n\n" + rest_ddl if rest_ddl else "")

        with open(output_main_path, 'w', encoding='utf-8') as f:
            f.write(final_main_sql.strip())

        if foreign_keys:
            with open(output_fk_path, 'w', encoding='utf-8') as f:
                f.write('\n'.join(foreign_keys))
            print(f"âœ… å¤–é”®æ–‡ä»¶å†™å…¥ï¼š{output_fk_path}")
        else:
            print(f"âš ï¸ æ— å¤–é”®è¯­å¥ï¼š{filename}")

        print(f"âœ… DDLä¸»æ–‡ä»¶å†™å…¥ï¼š{output_main_path}")

    except Exception as e:
        print(f"âŒ è½¬æ¢å¤±è´¥ï¼š{filename}ï¼Œé”™è¯¯ï¼š{e}")

# ======== å¹¶å‘è½¬æ¢å‡½æ•° ========
def convert_all_mysql_to_oracle_concurrently():
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    sql_files = [f for f in os.listdir(INPUT_DIR) if f.endswith('.sql')]

    with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
        futures = [executor.submit(process_single_file, file) for file in sql_files]
        for future in as_completed(futures):
            future.result()  # æ•è·å¼‚å¸¸è¾“å‡º

# ======== ä¸»å‡½æ•°å…¥å£ ========
def main():
    conn = pymysql.connect(
        host=mysql_conf['host'],
        port=mysql_conf.getint('port', 3306),
        user=mysql_conf['user'],
        password=mysql_conf['password'],
        database=mysql_conf['dbname'],
        charset='utf8mb4'
    )

    extract_table_ddl(conn)
    convert_all_mysql_to_oracle_concurrently()
    conn.close()

if __name__ == "__main__":
    main()
